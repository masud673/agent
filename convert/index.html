<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>এক্সেল থেকে CSV কনভার্টার | YetFix ফরম্যাট</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        .mobile-text {
            font-size: 0.875rem;
        }
        
        @media (min-width: 768px) {
            .mobile-text {
                font-size: 1rem;
            }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .file-upload-area {
            transition: all 0.3s ease;
        }
        
        .file-upload-area.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6 md:p-8 mb-6 card-hover">
                <div class="flex justify-center items-center mb-4">
                    <div class="relative">
                        <i class="fas fa-file-excel text-4xl md:text-5xl text-green-600 mr-2 md:mr-4"></i>
                        <i class="fas fa-arrow-right text-xl md:text-3xl text-gray-400 mx-1 md:mx-2"></i>
                        <i class="fas fa-file-csv text-4xl md:text-5xl text-blue-600 ml-2 md:ml-4"></i>
                    </div>
                </div>
                <h1 class="text-2xl md:text-4xl font-bold text-gray-800 mb-2">YetFix User Format Converter</h1>
                <p class="text-sm md:text-lg text-gray-600">এক্সেল ফাইলকে YetFix-এর প্রয়োজনীয় CSV ফরম্যাটে রূপান্তর করুন</p>
            </div>
        </header>

        <!-- Main Converter Card -->
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-4 md:p-6 mb-6 card-hover">
            <form id="converter-form">
                <!-- Form Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
                    <!-- Package Name -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold mobile-text">Package Name <span class="text-red-500">*</span></span>
                        </label>
                        <input type="text" id="package_name" required 
                               class="input input-bordered w-full focus:input-primary mobile-text" 
                               placeholder="প্যাকেজের নাম লিখুন">
                    </div>

                    <!-- Reseller Name -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold mobile-text">Reseller Name</span>
                        </label>
                        <input type="text" id="reseller_name" 
                               class="input input-bordered w-full focus:input-primary mobile-text" 
                               placeholder="রিসেলারের নাম লিখুন">
                    </div>

                    <!-- Zone/Pop -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold mobile-text">Zone/Pop <span class="text-red-500">*</span></span>
                        </label>
                        <input type="text" id="zone_pop" required 
                               class="input input-bordered w-full focus:input-primary mobile-text" 
                               placeholder="জোন বা পপ লিখুন">
                    </div>

                    <!-- Division -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold mobile-text">Division <span class="text-red-500">*</span></span>
                        </label>
                        <input type="text" id="division" required 
                               class="input input-bordered w-full focus:input-primary mobile-text" 
                               placeholder="বিভাগ লিখুন">
                    </div>

                    <!-- District -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold mobile-text">District <span class="text-red-500">*</span></span>
                        </label>
                        <input type="text" id="district" required 
                               class="input input-bordered w-full focus:input-primary mobile-text" 
                               placeholder="জেলা লিখুন">
                    </div>

                    <!-- Upazila -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold mobile-text">Upazila <span class="text-red-500">*</span></span>
                        </label>
                        <input type="text" id="upazila" required 
                               class="input input-bordered w-full focus:input-primary mobile-text" 
                               placeholder="উপজেলা লিখুন">
                    </div>
                </div>

                <!-- Demo Download Button -->
                <div class="flex justify-center mb-6">
                    <button type="button" id="demo-btn" 
                            class="btn btn-outline btn-primary gap-2 mobile-text">
                        <i class="fas fa-download"></i>
                        <span class="mobile-text">ডেমো এক্সেল ফাইল ডাউনলোড করুন</span>
                    </button>
                </div>

                <!-- File Upload Section -->
                <div class="mb-6">
                    <div id="file-upload-area" class="file-upload-area border-2 border-dashed border-gray-300 rounded-2xl p-6 md:p-8 text-center hover:border-primary transition-colors duration-300 bg-gray-50/50">
                        <input type="file" id="xlsx_file" accept=".xlsx" class="hidden" required>
                        <label for="xlsx_file" class="cursor-pointer">
                            <i class="fas fa-file-excel text-4xl md:text-6xl text-green-500 mb-4"></i>
                            <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">এক্সেল ফাইল নির্বাচন করুন</h3>
                            <p class="text-gray-500 mb-4 mobile-text">অথবা ফাইলটি এখানে ড্রপ করুন</p>
                            <div class="btn btn-primary gap-2 mobile-text">
                                <i class="fas fa-folder-open"></i>
                                <span class="mobile-text">ফাইল ব্রাউজ করুন</span>
                            </div>
                        </label>
                        <div id="file-name-display" class="mt-4 text-sm text-primary font-semibold mobile-text">
                            কোন ফাইল নির্বাচন করা হয়নি
                        </div>
                    </div>
                </div>

                <!-- Convert Button -->
                <div class="flex justify-center">
                    <button type="button" id="convert-btn" 
                            class="btn btn-primary btn-lg gap-2 min-w-[200px] mobile-text">
                        <i class="fas fa-exchange-alt"></i>
                        <span class="mobile-text">CSV এ রূপান্তর করুন</span>
                    </button>
                </div>
            </form>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center py-8">
                <div class="loading loading-spinner loading-lg text-primary mb-4"></div>
                <p class="text-gray-600 mobile-text">আপনার ফাইল প্রসেস করা হচ্ছে...</p>
            </div>
        </div>

        <!-- Result Section -->
        <div id="result" class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-4 md:p-6 hidden card-hover">
            <div class="flex items-center mb-4 md:mb-6">
                <i class="fas fa-check-circle text-2xl md:text-3xl text-success mr-3"></i>
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">রূপান্তর সম্পূর্ণ!</h2>
            </div>
            
            <p class="text-gray-600 mb-4 md:mb-6 mobile-text">আপনার CSV ফাইল ডাউনলোডের জন্য প্রস্তুত। প্রথম কয়েকটি সারির প্রিভিউ:</p>
            
            <!-- Preview Table -->
            <div class="mb-4 md:mb-6">
                <div class="preview-table-container border border-gray-200 rounded-lg">
                    <table id="csv-preview-table" class="table table-zebra table-sm w-full">
                        <!-- Table content will be generated by JavaScript -->
                    </table>
                </div>
                <p id="preview-note" class="text-xs md:text-sm text-gray-500 text-center mt-2"></p>
            </div>

            <!-- Download Button -->
            <div class="text-center">
                <button id="download-btn" class="btn btn-success btn-lg gap-2 mobile-text">
                    <i class="fas fa-download"></i>
                    <span class="mobile-text">CSV ফাইল ডাউনলোড করুন</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-6 md:mt-8">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-4 md:p-6 card-hover">
                <p class="text-gray-600 mobile-text">
                    Created by <span class="text-primary font-semibold">Masud Rana</span> | 
                    © 2025 All Rights Reserved
                </p>
            </div>
        </footer>
    </div>

    <script>
        // DOM Elements
        const xlsxFile = document.getElementById('xlsx_file');
        const fileNameDisplay = document.getElementById('file-name-display');
        const convertBtn = document.getElementById('convert-btn');
        const demoBtn = document.getElementById('demo-btn');
        const downloadBtn = document.getElementById('download-btn');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const fileUploadArea = document.getElementById('file-upload-area');

        // File name display
        xlsxFile.addEventListener('change', e => {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'কোন ফাইল নির্বাচন করা হয়নি';
            fileNameDisplay.textContent = fileName;
        });

        // Phone number formatting
        function formatPhone(phone) {
            if (!phone) return '';
            let digits = String(phone).replace(/\D/g, '');
            if (digits.length === 10) digits = '0' + digits;
            return digits;
        }

        // Show preview table
        function showPreview(data) {
            const table = document.getElementById('csv-preview-table');
            const note = document.getElementById('preview-note');
            table.innerHTML = '';

            if (data.length > 0) {
                const headerRow = document.createElement('tr');
                data[0].forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h || '';
                    th.className = 'bg-gray-100 font-bold mobile-text';
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
            }

            const rows = Math.min(10, data.length);
            for (let i = 1; i < rows; i++) {
                const tr = document.createElement('tr');
                data[i].forEach(c => {
                    const td = document.createElement('td');
                    td.textContent = c || '';
                    td.className = 'mobile-text';
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            }

            note.textContent = data.length > rows ?
                `প্রথম ${rows - 1}টি সারি দেখানো হচ্ছে (মোট ${data.length - 1}টি সারি)` :
                `মোট ${data.length - 1}টি সারি`;
        }

        // Demo file download - UPDATED WITH AREA COLUMN
        demoBtn.addEventListener('click', () => {
            const demoData = [
                ["ppoe user", "ppoe password", "Name", "Phone Number", "Expire Date", "Area"],
                ["demo123", "demo-password", "demo", "1700000000", "30/12/2025", "Area Name"],
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(demoData);
            
            const colWidths = [
                { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 12 }
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, "Demo Users");
            XLSX.writeFile(wb, "YetFix_Demo_Format.xlsx");
        });

        // Main conversion function - UPDATED TO READ AREA FROM EXCEL
        convertBtn.addEventListener('click', () => {
            const required = ['package_name', 'zone_pop', 'division', 'district', 'upazila'];
            const missing = [];
            
            required.forEach(id => {
                if (!document.getElementById(id).value.trim()) {
                    const label = document.querySelector(`label[for="${id}"]`).textContent.replace(' *', '');
                    missing.push(label);
                }
            });

            if (missing.length) {
                alert('অনুগ্রহ করে নিম্নলিখিত ফিল্ডগুলি পূরণ করুন:\n' + missing.join(', '));
                return;
            }

            if (!xlsxFile.files.length) {
                alert('এক্সেল ফাইল নির্বাচন করুন');
                return;
            }

            loading.classList.remove('hidden');
            convertBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });

                    const packageName = document.getElementById('package_name').value;
                    const resellerName = document.getElementById('reseller_name').value || 'N/A';
                    const zonePop = document.getElementById('zone_pop').value;
                    const division = document.getElementById('division').value;
                    const district = document.getElementById('district').value;
                    const upazila = document.getElementById('upazila').value;

                    const finalData = [];
                    finalData.push([
                        "ppoe user*", "ppoe password*", "Name*", "Phone No", "Packege Name*", "Reseller Name", 
                        "Zone/Pop*", "Expire Date*", "Email", "Father's Name", "Mother's Name", "Area", 
                        "Mikrotik Comment", "Joining Date", "Cable Type", "expire month*", "customer code", 
                        "Division*", "District*", "Upazila*", "Building Name", "expire year*"
                    ]);

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;

                        let expire = row[4] || '';
                        let expireDay = '', expireMonth = '', expireYear = '';
                        let joiningDate = '';
                        let area = row[5] || 'N/A'; // এক্সেল থেকে এরিয়া পড়া (6th কলাম)

                        if (expire) {
                            expire = expire.toString().replace(/\./g, '');
                            const parts = expire.split(/[\/\-]/);
                            
                            if (parts.length >= 3) {
                                expireDay = parts[0];
                                expireMonth = parts[1];
                                expireYear = parts[2];
                                joiningDate = `${expireDay}-${expireMonth}-${expireYear}`;
                            } else if (parts.length === 2) {
                                expireDay = parts[0];
                                expireMonth = parts[1];
                                expireYear = '2025';
                                joiningDate = `${expireDay}-${expireMonth}-${expireYear}`;
                            }

                            if (expireDay && expireDay.length === 1) expireDay = '0' + expireDay;
                            if (expireMonth && expireMonth.length === 1) expireMonth = '0' + expireMonth;
                        }

                        finalData.push([
                            row[0] || '', 
                            row[1] || '', 
                            row[2] || '', 
                            formatPhone(row[3]), 
                            packageName, 
                            resellerName, 
                            zonePop, 
                            expireDay,
                            'N/A', 'N/A', 'N/A', 
                            area, // এক্সেল থেকে নেওয়া এরিয়া ব্যবহার
                            '', 
                            joiningDate,
                            '',
                            expireMonth,
                            '',
                            division, 
                            district, 
                            upazila, 
                            '', 
                            expireYear
                        ]);
                    }

                    showPreview(finalData);

                    const ws2 = XLSX.utils.aoa_to_sheet(finalData);
                    let csvString = XLSX.utils.sheet_to_csv(ws2, { FS: ",", RS: "\n" });
                    csvString = csvString.split("\n")
                        .map(row => row.split(",")
                            .map(cell => `"${String(cell).replace(/[\r\n]+/g, '').trim()}"`)
                            .join(","))
                        .join("\r\n");

                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    downloadBtn.onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'YetFix_User.csv';
                        a.click();
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    };

                    loading.classList.add('hidden');
                    result.classList.remove('hidden');
                    convertBtn.disabled = false;

                } catch (error) {
                    console.error('Conversion error:', error);
                    alert('ফাইল প্রসেস করতে সমস্যা হয়েছে। দয়া করে আবার চেষ্টা করুন।');
                    loading.classList.add('hidden');
                    convertBtn.disabled = false;
                }
            };

            reader.readAsArrayBuffer(xlsxFile.files[0]);
        });

        // Drag and drop functionality
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('active');
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('active');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.xlsx')) {
                xlsxFile.files = files;
                fileNameDisplay.textContent = files[0].name;
            } else {
                alert('শুধুমাত্র .xlsx ফাইল সাপোর্টেড');
            }
        });
    </script>
</body>
</html>
